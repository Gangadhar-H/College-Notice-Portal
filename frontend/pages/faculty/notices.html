<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Notices - Notice Board System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../../css/style.css" />
    <style>
      .recipient-item {
        display: inline-block;
        padding: 5px 10px;
        margin: 5px;
        background: #e7f3ff;
        border-radius: 15px;
        border: 1px solid #0d6efd;
      }
      .recipient-item .remove-recipient {
        margin-left: 5px;
        cursor: pointer;
        color: #dc3545;
      }
      .file-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .file-preview-item {
        position: relative;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #f8f9fa;
        text-align: center;
      }
      .file-preview-item .remove-file {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div id="navbar"></div>

    <div class="page-container">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1><i class="fas fa-bell me-2"></i>My Notices</h1>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#noticeModal"
            onclick="openCreateModal()"
          >
            <i class="fas fa-plus me-2"></i>Create Notice
          </button>
        </div>

        <div class="row mb-3">
          <div class="col-md-8">
            <input
              type="text"
              class="form-control"
              id="searchInput"
              placeholder="Search notices..."
            />
          </div>
          <div class="col-md-4">
            <select class="form-select" id="typeFilter">
              <option value="">All Types</option>
              <option value="ALL">All Users</option>
              <option value="FACULTY">Faculty Only</option>
              <option value="CLASS">Class</option>
              <option value="SECTION">Section</option>
            </select>
          </div>
        </div>

        <div id="noticesContainer">${Components.createLoadingSpinner()}</div>
      </div>
    </div>

    <!-- Notice Modal -->
    <div class="modal fade" id="noticeModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Create Notice</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form id="noticeForm">
            <div class="modal-body">
              <input type="hidden" id="noticeId" />

              <div class="mb-3">
                <label for="noticeTitle" class="form-label">Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="noticeTitle"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="noticeMessage" class="form-label">Message</label>
                <textarea
                  class="form-control"
                  id="noticeMessage"
                  rows="5"
                  required
                ></textarea>
              </div>

              <div class="mb-3">
                <label for="noticeType" class="form-label">Notice Type</label>
                <select
                  class="form-select"
                  id="noticeType"
                  required
                  onchange="handleTypeChange()"
                >
                  <option value="">Select Type</option>
                  <option value="ALL">All Users</option>
                  <option value="FACULTY">Faculty Only</option>
                  <option value="CLASS">Class (All Sections)</option>
                  <option value="SECTION">Specific Sections</option>
                </select>
              </div>

              <!-- Recipients Section -->
              <div id="recipientsSection" style="display: none">
                <div class="mb-3">
                  <label class="form-label">Select Recipients</label>

                  <!-- For CLASS type -->
                  <div id="classSelection" style="display: none">
                    <div class="mb-2">
                      <select class="form-select" id="classSelector">
                        <option value="">Choose classes...</option>
                      </select>
                    </div>
                    <button
                      type="button"
                      class="btn btn-sm btn-primary"
                      onclick="addClassRecipient()"
                    >
                      <i class="fas fa-plus"></i> Add Class
                    </button>
                  </div>

                  <!-- For SECTION type -->
                  <div id="sectionSelection" style="display: none">
                    <div class="row mb-2">
                      <div class="col-md-6">
                        <select class="form-select" id="sectionClassSelector">
                          <option value="">First, select a class...</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <select
                          class="form-select"
                          id="sectionSelector"
                          disabled
                        >
                          <option value="">Then, select a section...</option>
                        </select>
                      </div>
                    </div>
                    <button
                      type="button"
                      class="btn btn-sm btn-primary"
                      onclick="addSectionRecipient()"
                    >
                      <i class="fas fa-plus"></i> Add Section
                    </button>
                  </div>

                  <!-- Selected Recipients Display -->
                  <div id="selectedRecipients" class="mt-3"></div>
                  <!-- File Attachments -->
                  <div class="mb-3">
                    <label for="noticeAttachments" class="form-label">
                      Attachments (Optional)
                      <small class="text-muted">- Max 5 files, 10MB each</small>
                    </label>
                    <input
                      type="file"
                      class="form-control"
                      id="noticeAttachments"
                      multiple
                      accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar"
                    />
                    <small class="text-muted">
                      Allowed: Images, PDF, Word, Excel, PowerPoint, Text, ZIP,
                      RAR
                    </small>
                    <div id="filePreview" class="file-preview"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/config.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/utils.js"></script>
    <script src="../../js/components.js"></script>

    <script>
      Auth.requireAuth([ROLES.FACULTY]);
      document.getElementById("navbar").innerHTML = Components.createNavbar(
        ROLES.FACULTY
      );

      let allNotices = [];
      let myClasses = [];
      let allSections = [];
      let editingNoticeId = null;
      let selectedFiles = [];
      let selectedRecipients = [];

      async function loadNotices() {
        try {
          const data = await API.getFacultyNotices();
          allNotices = data.notices;
          displayNotices(allNotices);
        } catch (error) {
          Utils.showToast("Failed to load notices", "danger");
        }
      }

      async function loadMyClasses() {
        try {
          const [classesData, sectionsData] = await Promise.all([
            API.getFacultyDepartments(),
            API.getFacultySections(),
          ]);

          myClasses = classesData.classes;
          allSections = sectionsData.sections;

          console.log("My Classes:", myClasses);
          console.log("All Sections:", allSections);

          populateSelectors();
        } catch (error) {
          console.error("Failed to load classes:", error);
          Utils.showToast("Failed to load classes and sections", "danger");
        }
      }

      // Handle file selection
      function handleFileChange(e) {
        const files = Array.from(e.target.files);

        if (files.length > 5) {
          Utils.showToast("Maximum 5 files allowed", "warning");
          e.target.value = "";
          return;
        }

        selectedFiles = files;
        displayFilePreview();
      }

      function displayFilePreview() {
        const container = document.getElementById("filePreview");

        if (selectedFiles.length === 0) {
          container.innerHTML = "";
          return;
        }

        container.innerHTML = selectedFiles
          .map(
            (file, index) => `
    <div class="file-preview-item">
      <button type="button" class="remove-file" onclick="removeFile(${index})">
        <i class="fas fa-times"></i>
      </button>
      <i class="${getFileIconByName(file.name)} fa-2x mb-2"></i>
      <div><small>${file.name}</small></div>
      <div><small class="text-muted">${formatFileSize(file.size)}</small></div>
    </div>
  `
          )
          .join("");
      }

      function getFileIconByName(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const iconMap = {
          jpg: "fas fa-file-image text-success",
          jpeg: "fas fa-file-image text-success",
          png: "fas fa-file-image text-success",
          gif: "fas fa-file-image text-success",
          pdf: "fas fa-file-pdf text-danger",
          doc: "fas fa-file-word text-primary",
          docx: "fas fa-file-word text-primary",
          xls: "fas fa-file-excel text-success",
          xlsx: "fas fa-file-excel text-success",
          ppt: "fas fa-file-powerpoint text-warning",
          pptx: "fas fa-file-powerpoint text-warning",
          zip: "fas fa-file-archive text-secondary",
          rar: "fas fa-file-archive text-secondary",
        };
        return iconMap[ext] || "fas fa-file";
      }

      function formatFileSize(bytes) {
        if (!bytes) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i]
        );
      }

      window.removeFile = function (index) {
        selectedFiles.splice(index, 1);
        displayFilePreview();

        // Update file input
        const input = document.getElementById("noticeAttachments");
        const dt = new DataTransfer();
        selectedFiles.forEach((file) => dt.items.add(file));
        input.files = dt.files;
      };

      // Add event listener for file input
      document
        .getElementById("noticeAttachments")
        .addEventListener("change", handleFileChange);

      function populateSelectors() {
        const classSelector = document.getElementById("classSelector");
        const sectionClassSelector = document.getElementById(
          "sectionClassSelector"
        );

        const classOptions = myClasses
          .map((cls) => `<option value="${cls.id}">${cls.name}</option>`)
          .join("");

        classSelector.innerHTML =
          '<option value="">Choose classes...</option>' + classOptions;
        sectionClassSelector.innerHTML =
          '<option value="">First, select a class...</option>' + classOptions;
      }

      function displayNotices(notices) {
        const container = document.getElementById("noticesContainer");

        if (notices.length === 0) {
          container.innerHTML = Components.createEmptyState("No notices found");
          return;
        }

        const currentUser = Auth.getUser();

        container.innerHTML = notices
          .map((notice) => {
            const recipientsHTML = getRecipientsHTML(notice);

            return `
              <div class="card mb-3 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-1">${Utils.escapeHtml(notice.title)}</h5>
                    <small class="text-muted">
                      <i class="fas fa-user"></i> ${Utils.escapeHtml(
                        notice.sender_name
                      )}
                    </small>
                  </div>
                  <div>
                    <span class="badge ${getNoticeTypeBadge(
                      notice.notice_type
                    )}">
                      ${getNoticeTypeLabel(notice.notice_type)}
                    </span>
                  </div>
                </div>
                <div class="card-body">
                  <p class="card-text">${Utils.escapeHtml(notice.message)}</p>
                  ${recipientsHTML}
                  <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                      <i class="fas fa-calendar"></i> ${Utils.formatDate(
                        notice.created_at
                      )}
                    </small>
                    ${
                      notice.sent_by === currentUser.id
                        ? `
                      <div>
                        <button class="btn btn-sm btn-warning" onclick="editNotice('${notice.id}')">
                          <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteNotice('${notice.id}')">
                          <i class="fas fa-trash"></i> Delete
                        </button>
                      </div>
                    `
                        : ""
                    }
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function getRecipientsHTML(notice) {
        if (
          notice.notice_type === "ALL" ||
          notice.notice_type === "FACULTY" ||
          !notice.recipients ||
          notice.recipients.length === 0
        ) {
          return "";
        }

        const recipients = notice.recipients
          .map((r) => {
            if (r.section_id) {
              return `<span class="badge bg-info">${Utils.escapeHtml(
                r.class_name
              )} - ${Utils.escapeHtml(
                r.section_display_name || "Section " + r.section_name
              )}</span>`;
            } else {
              return `<span class="badge bg-primary">${Utils.escapeHtml(
                r.class_name
              )} (All Sections)</span>`;
            }
          })
          .join(" ");

        return `
          <div class="mb-2">
            <strong>Recipients:</strong><br>
            ${recipients}
          </div>
        `;
      }

      function getNoticeTypeBadge(type) {
        const badges = {
          ALL: "bg-info",
          FACULTY: "bg-warning",
          CLASS: "bg-primary",
          SECTION: "bg-success",
        };
        return badges[type] || "bg-secondary";
      }

      function getNoticeTypeLabel(type) {
        const labels = {
          ALL: "All Users",
          FACULTY: "Faculty Only",
          CLASS: "Class/Year",
          SECTION: "Sections",
        };
        return labels[type] || type;
      }

      function handleTypeChange() {
        const type = document.getElementById("noticeType").value;
        const recipientsSection = document.getElementById("recipientsSection");
        const classSelection = document.getElementById("classSelection");
        const sectionSelection = document.getElementById("sectionSelection");

        selectedRecipients = [];
        updateRecipientsDisplay();

        if (type === "CLASS") {
          recipientsSection.style.display = "block";
          classSelection.style.display = "block";
          sectionSelection.style.display = "none";
        } else if (type === "SECTION") {
          recipientsSection.style.display = "block";
          classSelection.style.display = "none";
          sectionSelection.style.display = "block";
        } else {
          recipientsSection.style.display = "none";
          classSelection.style.display = "none";
          sectionSelection.style.display = "none";
        }
      }

      document
        .getElementById("sectionClassSelector")
        .addEventListener("change", (e) => {
          const classId = e.target.value;
          const sectionSelector = document.getElementById("sectionSelector");

          if (classId) {
            // Filter sections that belong to the selected class
            const sections = allSections.filter((s) => s.class_id === classId);

            if (sections.length === 0) {
              sectionSelector.disabled = true;
              sectionSelector.innerHTML =
                '<option value="">No sections available for this class</option>';
            } else {
              sectionSelector.disabled = false;
              sectionSelector.innerHTML =
                '<option value="">Then, select a section...</option>' +
                sections
                  .map(
                    (s) =>
                      `<option value="${s.id}">${
                        s.display_name || "Section " + s.name
                      }</option>`
                  )
                  .join("");
            }
          } else {
            sectionSelector.disabled = true;
            sectionSelector.innerHTML =
              '<option value="">Then, select a section...</option>';
          }
        });

      window.addClassRecipient = function () {
        const classId = document.getElementById("classSelector").value;
        if (!classId) {
          Utils.showToast("Please select a class", "warning");
          return;
        }

        if (
          selectedRecipients.some(
            (r) => r.class_id === classId && !r.section_id
          )
        ) {
          Utils.showToast("This class is already added", "warning");
          return;
        }

        const className = myClasses.find((c) => c.id === classId).name;
        selectedRecipients.push({ class_id: classId, class_name: className });
        updateRecipientsDisplay();
        document.getElementById("classSelector").value = "";
      };

      window.addSectionRecipient = function () {
        const sectionId = document.getElementById("sectionSelector").value;
        if (!sectionId) {
          Utils.showToast("Please select a section", "warning");
          return;
        }

        if (selectedRecipients.some((r) => r.section_id === sectionId)) {
          Utils.showToast("This section is already added", "warning");
          return;
        }

        const section = allSections.find((s) => s.id === sectionId);
        const className = myClasses.find((c) => c.id === section.class_id).name;

        selectedRecipients.push({
          section_id: sectionId,
          class_id: section.class_id,
          class_name: className,
          section_name: section.name,
          section_display_name: section.display_name,
        });

        updateRecipientsDisplay();
        document.getElementById("sectionClassSelector").value = "";
        document.getElementById("sectionSelector").value = "";
        document.getElementById("sectionSelector").disabled = true;
      };

      function updateRecipientsDisplay() {
        const container = document.getElementById("selectedRecipients");

        if (selectedRecipients.length === 0) {
          container.innerHTML =
            '<p class="text-muted">No recipients selected yet</p>';
          return;
        }

        container.innerHTML = selectedRecipients
          .map(
            (r, index) => `
          <span class="recipient-item">
            ${
              r.section_id
                ? `${r.class_name} - ${
                    r.section_display_name || "Section " + r.section_name
                  }`
                : `${r.class_name} (All Sections)`
            }
            <i class="fas fa-times remove-recipient" onclick="removeRecipient(${index})"></i>
          </span>
        `
          )
          .join("");
      }

      window.removeRecipient = function (index) {
        selectedRecipients.splice(index, 1);
        updateRecipientsDisplay();
      };

      function openCreateModal() {
        editingNoticeId = null;
        selectedRecipients = [];
        document.getElementById("modalTitle").textContent = "Create Notice";
        document.getElementById("noticeForm").reset();
        document.getElementById("recipientsSection").style.display = "none";
        updateRecipientsDisplay();
      }

      async function editNotice(noticeId) {
        editingNoticeId = noticeId;
        const notice = allNotices.find((n) => n.id === noticeId);

        if (!notice) return;

        document.getElementById("modalTitle").textContent = "Edit Notice";
        document.getElementById("noticeId").value = notice.id;
        document.getElementById("noticeTitle").value = notice.title;
        document.getElementById("noticeMessage").value = notice.message;
        document.getElementById("noticeType").value = notice.notice_type;

        selectedRecipients = notice.recipients || [];
        handleTypeChange();
        updateRecipientsDisplay();

        new bootstrap.Modal(document.getElementById("noticeModal")).show();
      }

      async function deleteNotice(noticeId) {
        if (
          !(await Utils.confirm("Are you sure you want to delete this notice?"))
        )
          return;

        try {
          await API.deleteFacultyNotice(noticeId);
          Utils.showToast("Notice deleted successfully", "success");
          loadNotices();
        } catch (error) {
          Utils.showToast(error.message || "Failed to delete notice", "danger");
        }
      }

      document
        .getElementById("noticeForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const title = document.getElementById("noticeTitle").value;
          const message = document.getElementById("noticeMessage").value;
          const notice_type = document.getElementById("noticeType").value;

          // Validate recipients for CLASS and SECTION types
          if (
            (notice_type === "CLASS" || notice_type === "SECTION") &&
            selectedRecipients.length === 0
          ) {
            Utils.showToast("Please select at least one recipient", "warning");
            return;
          }

          // Create FormData for file upload support
          const formData = new FormData();
          formData.append("title", title);
          formData.append("message", message);
          formData.append("notice_type", notice_type);
          formData.append("recipients", JSON.stringify(selectedRecipients));

          // Add files
          selectedFiles.forEach((file) => {
            formData.append("attachments", file);
          });

          try {
            if (editingNoticeId) {
              await API.updateFacultyNoticeWithFiles(editingNoticeId, formData);
              Utils.showToast("Notice updated successfully", "success");
            } else {
              await API.createFacultyNoticeWithFiles(formData);
              Utils.showToast("Notice created successfully", "success");
            }

            bootstrap.Modal.getInstance(
              document.getElementById("noticeModal")
            ).hide();
            loadNotices();
          } catch (error) {
            Utils.showToast(error.message || "Operation failed", "danger");
          }
        });

      document
        .getElementById("searchInput")
        .addEventListener("input", Utils.debounce(filterNotices, 300));
      document
        .getElementById("typeFilter")
        .addEventListener("change", filterNotices);

      function filterNotices() {
        const search = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const typeFilter = document.getElementById("typeFilter").value;

        const filtered = allNotices.filter((n) => {
          const matchesSearch =
            n.title.toLowerCase().includes(search) ||
            n.message.toLowerCase().includes(search);
          const matchesType = !typeFilter || n.notice_type === typeFilter;
          return matchesSearch && matchesType;
        });

        displayNotices(filtered);
      }

      loadNotices();
      loadMyClasses();
    </script>
  </body>
</html>
