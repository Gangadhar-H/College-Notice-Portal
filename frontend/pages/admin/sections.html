<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Section Management - Notice Board System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../../css/style.css" />
  </head>
  <body>
    <div id="navbar"></div>

    <div class="page-container">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1><i class="fas fa-layer-group me-2"></i>Section Management</h1>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#sectionModal"
            id="addSectionBtn"
          >
            <i class="fas fa-plus me-2"></i>Add Section
          </button>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Filter by Class:</label>
                <select class="form-select" id="classFilter">
                  <option value="">All Classes</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Search:</label>
                <input
                  type="text"
                  class="form-control"
                  id="searchInput"
                  placeholder="Search sections..."
                />
              </div>
            </div>
          </div>
        </div>

        <div class="row" id="sectionsContainer">
          <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section Modal -->
    <div class="modal fade" id="sectionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Add Section</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form id="sectionForm">
            <div class="modal-body">
              <input type="hidden" id="sectionId" />

              <div class="mb-3">
                <label for="classSelect" class="form-label">Class/Year</label>
                <select class="form-select" id="classSelect" required>
                  <option value="">Select Class</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="sectionName" class="form-label">Section Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="sectionName"
                  placeholder="e.g., A, B, C"
                  maxlength="10"
                  required
                />
                <small class="text-muted"
                  >Usually a single letter (A, B, C, etc.)</small
                >
              </div>

              <div class="mb-3">
                <label for="displayName" class="form-label"
                  >Display Name (Optional)</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="displayName"
                  placeholder="e.g., Section A, Division A"
                  maxlength="50"
                />
                <small class="text-muted"
                  >If empty, will default to "Section [Name]"</small
                >
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/config.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/utils.js"></script>
    <script src="../../js/components.js"></script>

    <script>
      Auth.requireAuth([ROLES.ADMIN]);
      document.getElementById("navbar").innerHTML = Components.createNavbar(
        ROLES.ADMIN
      );

      let allSections = [];
      let allClasses = [];
      let editingSectionId = null;

      async function loadData() {
        try {
          const [sectionsData, classesData] = await Promise.all([
            API.getAllSections(),
            API.getAllClasses(),
          ]);

          allSections = sectionsData.sections;
          allClasses = classesData.classes;

          populateClassFilters();
          displaySections(allSections);
        } catch (error) {
          Utils.showToast("Failed to load data", "danger");
        }
      }

      function populateClassFilters() {
        const classFilter = document.getElementById("classFilter");
        const classSelect = document.getElementById("classSelect");

        const classOptions = allClasses
          .map((cls) => `<option value="${cls.id}">${cls.name}</option>`)
          .join("");

        classFilter.innerHTML =
          '<option value="">All Classes</option>' + classOptions;
        classSelect.innerHTML =
          '<option value="">Select Class</option>' + classOptions;
      }

      function displaySections(sections) {
        const container = document.getElementById("sectionsContainer");

        if (sections.length === 0) {
          container.innerHTML = `
            <div class="col-12">
              ${Components.createEmptyState(
                "No sections found",
                "fas fa-layer-group"
              )}
            </div>
          `;
          return;
        }

        // Group sections by class
        const groupedSections = {};
        sections.forEach((section) => {
          if (!groupedSections[section.class_name]) {
            groupedSections[section.class_name] = [];
          }
          groupedSections[section.class_name].push(section);
        });

        let html = "";
        for (const className in groupedSections) {
          html += `
            <div class="col-12 mb-4">
              <h4 class="mb-3">
                <i class="fas fa-graduation-cap text-primary me-2"></i>${Utils.escapeHtml(
                  className
                )}
              </h4>
              <div class="row">
          `;

          groupedSections[className].forEach((section) => {
            html += `
              <div class="col-md-3 col-sm-6 mb-3">
                <div class="card shadow-sm h-100">
                  <div class="card-body text-center">
                    <div class="display-6 text-primary mb-2">
                      ${Utils.escapeHtml(section.name)}
                    </div>
                    <h6 class="card-title">
                      ${Utils.escapeHtml(
                        section.display_name || "Section " + section.name
                      )}
                    </h6>
                    <div class="mt-3 d-flex gap-2 justify-content-center">
                      <button class="btn btn-sm btn-warning" onclick="editSection('${
                        section.id
                      }')">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteSection('${
                        section.id
                      }')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            `;
          });

          html += `
              </div>
            </div>
          `;
        }

        container.innerHTML = html;
      }

      function openCreateModal() {
        editingSectionId = null;
        document.getElementById("modalTitle").textContent = "Add Section";
        document.getElementById("sectionForm").reset();
        document.getElementById("sectionId").value = "";
      }

      async function editSection(sectionId) {
        editingSectionId = sectionId;
        const section = allSections.find((s) => s.id === sectionId);

        if (!section) return;

        document.getElementById("modalTitle").textContent = "Edit Section";
        document.getElementById("sectionId").value = section.id;
        document.getElementById("classSelect").value = section.class_id;
        document.getElementById("sectionName").value = section.name;
        document.getElementById("displayName").value =
          section.display_name || "";

        new bootstrap.Modal(document.getElementById("sectionModal")).show();
      }

      async function deleteSection(sectionId) {
        if (
          !(await Utils.confirm(
            "Are you sure? This will affect students assigned to this section."
          ))
        )
          return;

        try {
          await API.deleteSection(sectionId);
          Utils.showToast("Section deleted successfully", "success");
          loadData();
        } catch (error) {
          Utils.showToast(
            error.message || "Failed to delete section",
            "danger"
          );
        }
      }

      document
        .getElementById("addSectionBtn")
        .addEventListener("click", openCreateModal);

      document
        .getElementById("sectionForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const class_id = document.getElementById("classSelect").value;
          const name = document
            .getElementById("sectionName")
            .value.toUpperCase();
          const display_name = document.getElementById("displayName").value;

          const sectionData = { class_id, name, display_name };

          try {
            if (editingSectionId) {
              await API.updateSection(editingSectionId, {
                name,
                display_name,
              });
              Utils.showToast("Section updated successfully", "success");
            } else {
              await API.createSection(sectionData);
              Utils.showToast("Section created successfully", "success");
            }

            bootstrap.Modal.getInstance(
              document.getElementById("sectionModal")
            ).hide();
            loadData();
          } catch (error) {
            Utils.showToast(error.message || "Operation failed", "danger");
          }
        });

      document.getElementById("classFilter").addEventListener("change", (e) => {
        const classId = e.target.value;
        if (classId) {
          const filtered = allSections.filter((s) => s.class_id === classId);
          displaySections(filtered);
        } else {
          displaySections(allSections);
        }
      });

      document.getElementById("searchInput").addEventListener(
        "input",
        Utils.debounce((e) => {
          const search = e.target.value.toLowerCase();
          const filtered = allSections.filter(
            (s) =>
              s.name.toLowerCase().includes(search) ||
              s.display_name.toLowerCase().includes(search) ||
              s.class_name.toLowerCase().includes(search)
          );
          displaySections(filtered);
        }, 300)
      );

      loadData();
    </script>
  </body>
</html>
